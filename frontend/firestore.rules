rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions for reference validation
    function isValidUserRef(userRef) {
      return userRef is path && 
             exists(userRef) && 
             get(userRef).data.role != null;
    }
    
    function isValidExpertRef(expertRef) {
      return expertRef is path && 
             exists(expertRef) && 
             get(expertRef).data.isApproved == true;
    }
    
    function userOwnsExpert(userId, expertRef) {
      return expertRef is path && 
             get(expertRef).data.userId == userId;
    }
    
    // Check if user has admin permissions
    function hasAdminPermission(permission) {
      return exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.isActive == true;
    }
    
    function isAdmin() {
      return exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.isActive == true;
    }

    // Users collection - supports both patterns
    match /users/{userId} {
      allow read: if request.auth != null && (
        // Users can read their own data
        request.auth.uid == userId ||
        // Admins can read all users
        isAdmin()
      );
      
      allow create: if request.auth != null && request.auth.uid == userId;
      
      allow update, delete: if request.auth != null && (
        // Users can update/delete their own data
        request.auth.uid == userId ||
        // Admins can update/delete users
        isAdmin()
      );
      
      // Allow webhook updates to subscription data (for development)
      allow write: if request.resource.data.keys().hasAll(['subscription', 'updatedAt']) 
        && request.resource.data.keys().size() <= 3;
        
      // Allow payments subcollection writes (for webhooks)
      match /payments/{paymentId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if true; // For webhook writes in development
      }
    }
    
    // Admin users collection
    match /admin_users/{adminId} {
      allow read: if request.auth != null && (
        // Admins can read their own record
        request.auth.uid == adminId ||
        // Super admins can read all admin records
        (exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.role == 'super_admin')
      );
      
      // Only super admins can write to admin records
      allow write: if request.auth != null &&
        exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.role == 'super_admin';
    }
    
    // Travel Preferences - supports both patterns
    match /travelPreferences/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read, update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;
    }
    
    // Trips with User References only
    match /trips/{tripId} {
      allow read: if request.auth != null && (
        resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid) ||
        // Shared trip access
        exists(/databases/$(database)/documents/tripShares/$(tripId)) ||
        // Admin access for user management
        isAdmin()
      );
      
      allow create: if request.auth != null && 
        request.resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid);
      
      allow update: if request.auth != null && 
        resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid);
      
      allow delete: if request.auth != null && 
        resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid);
    }
    
    // Chat Messages with References - supports both patterns
    match /chat_messages/{messageId} {
      allow read: if request.auth != null && (
        // Legacy: String userId
        request.auth.uid == resource.data.userId ||
        // New: User reference
        (resource.data.userRef != null &&
         resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid)) ||
        // Can read if part of the trip (legacy)
        (resource.data.tripId != null &&
         exists(/databases/$(database)/documents/trips/$(resource.data.tripId)) &&
         get(/databases/$(database)/documents/trips/$(resource.data.tripId)).data.userId == request.auth.uid) ||
        // Can read if part of the trip (new)
        (resource.data.tripRef != null &&
         get(resource.data.tripRef).data.userRef == /databases/$(database)/documents/users/$(request.auth.uid))
      );
      
      allow create: if request.auth != null && (
        request.resource.data.userId == request.auth.uid ||
        (request.resource.data.userRef != null &&
         request.resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid))
      );
      
      // Messages are immutable
      allow update: if false;
      allow delete: if false;
    }
    
    // Chat Sessions - supports both patterns
    match /chat_sessions/{sessionId} {
      allow read, write: if request.auth != null && (
        request.auth.uid == resource.data.userId ||
        (resource.data.userRef != null &&
         resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid))
      );
      
      allow create: if request.auth != null && (
        request.resource.data.userId == request.auth.uid ||
        (request.resource.data.userRef != null &&
         request.resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid))
      );
    }
    
    // Packing Lists with References only
    match /packing_lists/{listId} {
      // Allow read if authenticated - needed for queries
      allow read: if request.auth != null;
      
      // Allow list/get if user owns the packing list or the associated trip
      allow get: if request.auth != null && (
        resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid) ||
        // Also allow if the user owns the trip associated with this packing list
        (resource.data.tripRef != null && 
         exists(resource.data.tripRef) && 
         get(resource.data.tripRef).data.userRef == /databases/$(database)/documents/users/$(request.auth.uid))
      );
      
      allow create: if request.auth != null && 
        request.resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid);
      
      allow update, delete: if request.auth != null && 
        resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid);
    }
    
    // Flights with References only
    match /flights/{flightId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null && 
        request.resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid);
      
      allow update, delete: if request.auth != null && 
        resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid);
    }
    
    // Travel Segments with References only
    match /travel_segments/{segmentId} {
      // Allow read if authenticated - needed for queries
      allow read: if request.auth != null;
      
      // Allow get if user owns the segment or the associated trip
      allow get: if request.auth != null && (
        resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid) ||
        // Also allow if the user owns the trip associated with this segment
        (resource.data.tripRef != null && 
         exists(resource.data.tripRef) && 
         get(resource.data.tripRef).data.userRef == /databases/$(database)/documents/users/$(request.auth.uid))
      );
      
      allow create: if request.auth != null && 
        request.resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid);
      
      allow update, delete: if request.auth != null && 
        resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid);
    }
    
    // Trip Shares with References - supports both patterns
    match /tripShares/{shareId} {
      allow read: if request.auth != null && (
        // Owner can read (legacy)
        request.auth.uid == resource.data.ownerId ||
        // Owner can read (new)
        (resource.data.ownerRef != null &&
         resource.data.ownerRef == /databases/$(database)/documents/users/$(request.auth.uid)) ||
        // Anyone with the token can read (public share)
        true
      );
      
      allow create: if request.auth != null && (
        // Must own the trip being shared
        (request.resource.data.ownerId == request.auth.uid) ||
        (request.resource.data.ownerRef == /databases/$(database)/documents/users/$(request.auth.uid))
      );
      
      allow update: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        (resource.data.ownerRef != null &&
         resource.data.ownerRef == /databases/$(database)/documents/users/$(request.auth.uid))
      );
      
      allow delete: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        (resource.data.ownerRef != null &&
         resource.data.ownerRef == /databases/$(database)/documents/users/$(request.auth.uid))
      );
    }
    
    // Marketplace Experts - supports both patterns
    match /marketplace_experts/{expertId} {
      allow read: if true; // Public profiles
      
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.userId &&
        request.resource.data.isApproved == false;
      
      allow update: if request.auth != null && (
        // Expert can update their own profile
        request.auth.uid == resource.data.userId ||
        // Admin can approve experts
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
      
      allow delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Marketplace Products with Reference Support
    match /marketplace_products/{productId} {
      allow read: if true; // Public products
      
      allow create: if request.auth != null && (
        // Legacy: Check string expertId
        (request.resource.data.expertId != null &&
         get(/databases/$(database)/documents/marketplace_experts/$(request.resource.data.expertId)).data.userId == request.auth.uid) ||
        // New: Check expertRef reference
        (request.resource.data.expertRef != null &&
         userOwnsExpert(request.auth.uid, request.resource.data.expertRef))
      );
      
      allow update: if request.auth != null && (
        // Legacy: Check string expertId
        (resource.data.expertId != null &&
         get(/databases/$(database)/documents/marketplace_experts/$(resource.data.expertId)).data.userId == request.auth.uid) ||
        // New: Check expertRef reference
        (resource.data.expertRef != null &&
         userOwnsExpert(request.auth.uid, resource.data.expertRef)) ||
        // Admin access
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
      
      allow delete: if request.auth != null && (
        // Legacy: Check string expertId
        (resource.data.expertId != null &&
         get(/databases/$(database)/documents/marketplace_experts/$(resource.data.expertId)).data.userId == request.auth.uid) ||
        // New: Check expertRef reference
        (resource.data.expertRef != null &&
         userOwnsExpert(request.auth.uid, resource.data.expertRef)) ||
        // Admin access
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }
    
    // Marketplace Transactions with Reference Support
    match /marketplace_transactions/{transactionId} {
      allow read: if request.auth != null && (
        // Legacy: String IDs
        request.auth.uid == resource.data.buyerId ||
        request.auth.uid == resource.data.sellerId ||
        // New: Reference fields - buyer can read their own transactions
        (resource.data.buyerRef != null && 
         resource.data.buyerRef == /databases/$(database)/documents/users/$(request.auth.uid)) ||
        // New: Expert can read transactions for their products
        (resource.data.expertRef != null &&
         userOwnsExpert(request.auth.uid, resource.data.expertRef)) ||
        // Admin access
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
      
      allow create: if request.auth != null && (
        // Legacy: buyerId must match auth user
        (request.resource.data.buyerId == request.auth.uid) ||
        // New: buyerRef must point to auth user
        (request.resource.data.buyerRef == /databases/$(database)/documents/users/$(request.auth.uid))
      );
      
      // Transactions are immutable except for status updates by system
      allow update: if false;
      allow delete: if false;
    }
    
    // Marketplace Reviews with Reference Support
    match /marketplace_reviews/{reviewId} {
      allow read: if true; // Public reviews
      
      allow create: if request.auth != null && (
        // Must be the buyer (legacy string ID)
        request.resource.data.buyerId == request.auth.uid ||
        // Must be the buyer (new reference)
        (request.resource.data.buyerRef != null &&
         request.resource.data.buyerRef == /databases/$(database)/documents/users/$(request.auth.uid))
      ) && 
      // Must have purchased the product
      exists(/databases/$(database)/documents/marketplace_transactions/$(request.resource.data.transactionId));
      
      allow update: if request.auth != null && (
        // Legacy: Original reviewer only
        resource.data.buyerId == request.auth.uid ||
        // New: Original reviewer via reference
        (resource.data.buyerRef != null &&
         resource.data.buyerRef == /databases/$(database)/documents/users/$(request.auth.uid))
      );
      
      allow delete: if request.auth != null && (
        // Reviewer can delete their own review
        resource.data.buyerId == request.auth.uid ||
        (resource.data.buyerRef != null &&
         resource.data.buyerRef == /databases/$(database)/documents/users/$(request.auth.uid)) ||
        // Admin can delete any review
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }
    
    // Marketplace Applications
    match /marketplace_applications/{applicationId} {
      allow read: if request.auth != null && (
        // Applicant can read their own application
        request.auth.uid == resource.data.userId ||
        // Admin can read all applications
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
      
      allow create: if request.auth != null &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.status == 'pending';
      
      allow update: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      allow delete: if false;
    }
    
    // Place Recommendations
    match /place_recommendations/{recommendationId} {
      allow read: if true; // Public recommendations
      
      allow create: if request.auth != null && (
        // Expert creating recommendation
        (request.resource.data.recommendedBy.type == 'expert' &&
         exists(/databases/$(database)/documents/marketplace_experts/$(request.resource.data.recommendedBy.id)) &&
         get(/databases/$(database)/documents/marketplace_experts/$(request.resource.data.recommendedBy.id)).data.userId == request.auth.uid) ||
        // Admin/system creating recommendation
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
      
      allow update: if request.auth != null && (
        // Expert updating their own recommendation
        (resource.data.recommendedBy.type == 'expert' &&
         resource.data.recommendedBy.id != null &&
         get(/databases/$(database)/documents/marketplace_experts/$(resource.data.recommendedBy.id)).data.userId == request.auth.uid) ||
        // Admin access
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
      
      allow delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Expert Saved Places
    match /expert_saved_places/{savedPlaceId} {
      allow read: if request.auth != null && (
        // Expert can read their own saved places
        (resource.data.expertId != null &&
         get(/databases/$(database)/documents/marketplace_experts/$(resource.data.expertId)).data.userId == request.auth.uid) ||
        // Admin access
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
      
      allow create: if request.auth != null &&
        request.resource.data.expertId != null &&
        get(/databases/$(database)/documents/marketplace_experts/$(request.resource.data.expertId)).data.userId == request.auth.uid;
      
      allow update, delete: if request.auth != null &&
        resource.data.expertId != null &&
        get(/databases/$(database)/documents/marketplace_experts/$(resource.data.expertId)).data.userId == request.auth.uid;
    }
    
    // User Saved Recommendations
    match /user_saved_recommendations/{savedId} {
      allow read, write: if request.auth != null &&
        request.auth.uid == resource.data.userId;
      
      allow create: if request.auth != null &&
        request.resource.data.userId == request.auth.uid;
    }
    
    // Admin Users
    match /admin_users/{adminId} {
      allow read: if request.auth != null && (
        // Admin can read their own record
        request.auth.uid == adminId ||
        // Super admin can read all
        get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.role == 'super_admin'
      );
      
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.role == 'super_admin';
    }
    
    // Help Articles
    match /help_articles/{articleId} {
      allow read: if true; // Public help articles
      
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Help Categories
    match /help_categories/{categoryId} {
      allow read: if true; // Public categories
      
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Article Feedback
    match /help_feedback/{feedbackId} {
      allow read: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      allow create: if request.auth != null &&
        request.resource.data.userId == request.auth.uid;
      
      allow update, delete: if false;
    }
    
    // Captures - supports both patterns (userId and userRef)
    match /captures/{captureId} {
      // Allow read if authenticated - needed for queries
      allow read: if request.auth != null;
      
      // Allow get if user owns the capture
      allow get: if request.auth != null && (
        // Legacy: String userId
        request.auth.uid == resource.data.userId ||
        // New: User reference
        (resource.data.userRef != null &&
         resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid)) ||
        // Can read if assigned to user's trip
        (resource.data.assignedTo != null &&
         exists(/databases/$(database)/documents/trips/$(resource.data.assignedTo)) &&
         get(/databases/$(database)/documents/trips/$(resource.data.assignedTo)).data.userRef == /databases/$(database)/documents/users/$(request.auth.uid))
      );
      
      allow create: if request.auth != null && (
        // Legacy: userId must match
        request.resource.data.userId == request.auth.uid ||
        // New: userRef must point to auth user
        (request.resource.data.userRef != null &&
         request.resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid))
      );
      
      allow update: if request.auth != null && (
        // Legacy: Owner can update
        resource.data.userId == request.auth.uid ||
        // New: Owner via reference can update
        (resource.data.userRef != null &&
         resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid))
      );
      
      allow delete: if request.auth != null && (
        // Legacy: Owner can delete
        resource.data.userId == request.auth.uid ||
        // New: Owner via reference can delete
        (resource.data.userRef != null &&
         resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid))
      );
    }
    
    // Error Logs (admin only)
    match /errorLogs/{logId} {
      allow read: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      allow create: if request.auth != null;
      allow update, delete: if false;
    }
    
    // Webhook Events (for idempotency)
    match /webhook_events/{eventId} {
      allow read: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // Allow webhooks to create (no auth required for webhook endpoints)
      allow create: if true;
      allow update, delete: if false;
    }
    
    // Email Tracking (for idempotency)
    match /email_tracking/{trackingId} {
      allow read: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // Allow webhooks to create (no auth required for webhook endpoints)
      allow create: if true;
      allow update, delete: if false;
    }
  }
}